<!DOCTYPE html>
<html lang="eng">
    <head>
        <title>My Bookings</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="./reset.css">
        <link rel="stylesheet" type="text/css" href="./flounder.css">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    </head>
        <body>
         <!--Navigation menu for users-->
         <nav class="menu">
            <img src="./favicon.ico" width="256" height="256">
            <ul>
               <a href="./overview.html"><li>Book an instrument</li></a>
               <a href="#"><li>My Bookings</li></a>
               <a href="#"><li>Administrator</li></a>
               <a href="./maintenance.html"><li>Maintenance</li></a>
            </ul>
         </nav>

            <div class="grid sched">
            <h1 class="overview_title">My Bookings</h1>
            <div id="my_schedule"></div>
            </div>

            <div class="grid book">
            <h1>Revoke a booking</h1>
            <label for="bookings">Choose a booking:</label>
            <form id="revoke">
               <select name="bookings" id="booking_menu">
               </select>
               <br>
            <button type="submit" value="submit" id="revoke_submit">Revoke</button>
            </form>
         </div>
              <script>

               //SSN from storage
               var SSN = localStorage.getItem("ssn");

               function getBookings() {

                  //XML part
                  var xhttp = new XMLHttpRequest();
                  xhttp.open("POST", "/get_personal_schedule", true);
                  xhttp.onreadystatechange = function() {
                     if (this.readyState == 4 && this.status == 200) {
                        var bookings = JSON.parse(this.responseText);

                        //Error handling
                        if (bookings.error) {
                           console.log(error);
                           return;
                        }
                        
                        //Dunno?? 
                        let schedule = document.querySelector('#my_schedule');
                        
                        //Container element for list
                        let container = document.createElement('div');

                        //Make list 
                        let list = document.createElement('ul');

                        //Add to page
                        //document.getElementsByTagName('body')[0].appendChild(container);
                        schedule.appendChild(container);
                        container.appendChild(list); 
                        
                        for (let i = 0; i < bookings.length; i++) {
                        // create an item for each one
                        listItem = document.createElement('li');

                        // Add the item
                        listItem.innerHTML = 'Booking Number: ' + bookings[i].BookingID + '<br> Instrument: ' + bookings[i].Description + '<br> Start: ' + bookings[i].StartTime + '<br> End: ' + bookings[i].EndTime;

                        // Add listItem to the listElement
                        list.appendChild(listItem);
                        }
                     }  
                  };
                  //Send request and info to server 
                  xhttp.send(JSON.stringify({'SSN': SSN}));
               }

            function populateMenu() {
            //XML request to server
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/get_personal_schedule", true);
            xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               var bookings = JSON.parse(this.responseText);

               //Error handling
               if (bookings.error) {
                  console.log(bookings.error)
                  return;
               }

               //Declaring drop down menu
               let menu = document.querySelector("#booking_menu");

               //Adding each booking to menu
               for (let i = 0; i < bookings.length; i++) {
                  let booking_alt = document.createElement('option');
                  booking_alt.innerHTML = bookings[i].BookingID; 
                  menu.appendChild(booking_alt);
                     }

                     //var form = document.getElementById("revoke");
                     //Will this return the specific id? 
                     document.getElementById("revoke_submit").addEventListener("click", function () {
                     revokebooking(booking_alt);
                  });
               }


            };
               //Send request and info to server
               xhttp.send(JSON.stringify({'SSN': SSN}));
         }

            function revokeBooking(bookingID) {
            //XML request to server
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/revoke_instrument_reservation", true);
            xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               var bookings = JSON.parse(this.responseText);

               //Error handling
               if (bookings.error) {
                  console.log(bookings.error)
                  return;
               }
               
            }
         };
         //Send request and info to server
         xhttp.send(JSON.stringify({'bookingID': bookingID}));
      }

               getBookings(); 
               populateMenu(); 

              </script>


              </div>
        </body>
</html>
