<!DOCTYPE html>
<html lang="eng">
    <head>
        <title>My Bookings</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="./reset.css">
        <link rel="stylesheet" type="text/css" href="./flounder.css">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
        <body>
         <!--Navigation menu for users-->
         <nav class="menu">
            <img src="./favicon.ico" width="256" height="256">
            <ul>
               <a href="./overview.html"><li>Book an instrument</li></a>
               <a href="#"><li>My Bookings</li></a>
               <a href="./ADMIN_DEMO_2.html"><li>Administrator</li></a>
               <a href="./maintenance.html"><li>Maintenance</li></a>
               <a href="#" onclick="logOut()"><li>Log out</li></a>
            </ul>
         </nav>

            <div class="grid sched">
            <h1 class="overview_title">My Bookings</h1>
            <div id="my_schedule"></div>
            </div>

            <div class="grid book">
            <h1>Revoke a booking</h1>
            <label for="bookings">Choose a booking:</label>
            <form id="revoke"  onsubmit="revokeBooking(); return false" action="...">
               <select name="booking_id" id="booking_menu" > 
               </select>
               <br>
            <button id="revoke_submit" type ="submit">Revoke</button>
            <div id="revoke_message"></div>
            </form>
         </div>
              <script>

               //SSN from storage
               var SSN = localStorage.getItem("ssn");

               //Todays date
               var today = new Date();
                  let current_year = today.getFullYear();
                  let current_month = today.getMonth();
                  let current_date = today.getDate();
                  let current_weekday = today.getDay();

               function getBookings() {

                  //XML part
                  var xhttp = new XMLHttpRequest();
                  xhttp.open("POST", "/get_personal_schedule", true);
                  xhttp.onreadystatechange = function() {
                     if (this.readyState == 4 && this.status == 200) {
                        var bookings = JSON.parse(this.responseText);

                        //Error handling
                        if (bookings.error) {
                           console.log("an error occured on the server:", bookings.error);
                           return;
                        }
                        else {
                        let schedule = document.querySelector('#my_schedule');
                        
                        //Container element for list
                        let container = document.createElement('div');

                        //Make list 
                        let list = document.createElement('ul');

                        //Add to page
                        //document.getElementsByTagName('body')[0].appendChild(container);
                        schedule.appendChild(container);
                        container.appendChild(list); 
                        

                        for (let i = 0; i < bookings.length; i++) {
                        var start = new Date(bookings[i].StartTime);

                        //Show upcoming bookings
                        if (start.toLocaleDateString() > today.toLocaleDateString() || start.toLocaleDateString() === today.toLocaleDateString() && start.toLocaleTimeString() > today.toLocaleTimeString() ) {
                        // create an item for each one
                        listItem = document.createElement('li');
                        listItem.classList.add('book_list');

                        // Add the item
                        listItem.innerHTML = 'Booking Number: ' + bookings[i].BookingID + 
                        '<br> Instrument: ' + bookings[i].Description + 
                        '<br> Start: ' + start.toLocaleDateString() + ' ' + start.toLocaleTimeString(navigator.language, {hour: '2-digit', minute:'2-digit'}) + 
                        '<br> End: ' + new Date(bookings[i].EndTime).toLocaleDateString() + ' ' + new Date(bookings[i].EndTime).toLocaleTimeString(navigator.language, {hour: '2-digit', minute:'2-digit'});

                        // Add listItem to the listElement
                        list.appendChild(listItem);
                        }

                        //Show expired bookings
                        else {
                        listItem = document.createElement('li');
                        listItem.classList.add('book_list_expired');

                        // Add the item
                        listItem.innerHTML = 'Booking Number: ' + bookings[i].BookingID + 
                        '<br> Instrument: ' + bookings[i].Description + 
                        '<br> Start: ' + start.toLocaleDateString() + ' ' + start.toLocaleTimeString(navigator.language, {hour: '2-digit', minute:'2-digit'}) + 
                        '<br> End: ' + new Date(bookings[i].EndTime).toLocaleDateString() + ' ' + new Date(bookings[i].EndTime).toLocaleTimeString(navigator.language, {hour: '2-digit', minute:'2-digit'});

                        list.appendChild(listItem);
                        }
                        }
                     }
                     }
                  };
                  //Send request and info to server 
                  xhttp.send(JSON.stringify({'SSN': SSN}));
               }

            function populateMenu() {
            //XML request to server
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/get_personal_schedule", true);
            xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               var bookings = JSON.parse(this.responseText);

               //Error handling
               if (bookings.error) {
                  console.log("an error occured on the server:", bookings.error);
                  return;
               }

               //Declaring drop down menu
               let menu = document.querySelector("#booking_menu");

               //Adding each booking to menu
               for (let i = 0; i < bookings.length; i++) {
                  var start = new Date(bookings[i].StartTime);
                  if (start.toLocaleDateString() > today.toLocaleDateString() || start.toLocaleDateString() === today.toLocaleDateString() && start.toLocaleTimeString() > today.toLocaleTimeString() ) {
                  let booking_alt = document.createElement('option');
                  booking_alt.innerHTML = "Booking number " + bookings[i].BookingID; 
                  booking_alt.value = bookings[i].BookingID;
                  menu.appendChild(booking_alt);
                     }
                  }

                  //document.getElementById("revoke_submit").addEventListener("click", function () {
                  //revokebooking();
                  //});
               }


            };
               //Send request and info to server
               xhttp.send(JSON.stringify({'SSN': SSN}));
         }

            function revokeBooking() {
            //XML request to server
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/revoke_reservation", true);
            xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               var response = JSON.parse(this.responseText);

               //Error handling
               if (response.error) {
                  console.log("an error occured on the server: " + response.error)
                  document.getElementById("revoke_message").innerHTML = "Server error"
                  return;
               }
               else {
                  location.reload();
                  document.getElementById("revoke_message").innerHTML = "Revoke successful!"
               }
               
            }
         };
         //Send request and info to server
         xhttp.send($("#revoke").serialize() + '&ssn=' + localStorage.getItem("ssn"));
      }

      function logOut() {
         localStorage.removeItem("ssn");
         localStorage.removeItem("email");
         localStorage.removeItem("admin");
         localStorage.removeItem("main");
         if (!localStorage.getItem("ssn")) {
            window.location.replace("index.html");
       }
      }
               getBookings(); 
               populateMenu(); 

              </script>


              </div>
        </body>
</html>
