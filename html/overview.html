<!DOCTYPE html>
<html lang="eng">
   <head>
      <title>Book an instrument</title>
      <meta charset="UTF-8">
      <link rel="stylesheet" type="text/css" href="./reset.css">
      <link rel="stylesheet" type="text/css" href="./flounder.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <link rel="preconnect" href="https://fonts.gstatic.com">
      <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
   </head>

   <body>
      <!--Navigation menu for users-->
      <nav class="menu">
         <img src="./favicon.ico" width="256" height="256">
         <ul id="menu_list">
            <a href="#"><li>Book an instrument</li></a>
            <a href="./my_schedule.html"><li>My Bookings</li></a>
         </ul>
         <a id="log_out" onclick="logOut()">Log out</a>
         <div id="email"></div>
      </nav>

      <main id="overview_cont">
         <div class="grid grid_room">
            <h1 class="overview_title">Room overview</h1>
            <div id="room_overview"></div>
         </div>

         <div class="grid grid_sched">
            <h1 class="overview_title">Book an instrument</h1>
            <div id="schedule">
               <p id="info_text">Select a room and instrument under room overview</p>
               <div id="change_buttons"></div>
               <table id="ins_table">
                  <thead id="date"></thead>
                  <tbody id="timeSlots"></tbody>
               </table>
               <form id="booking_form"></form>
            </div>

         </div>


         <script>

            //Email and SSN storage
            if (!localStorage.getItem("ssn")) {
               var ssn = $$SSN$$;
               localStorage.setItem("ssn", ssn);
            }
            if (!localStorage.getItem("email")) {
               var email = $$EMAIL$$;
               localStorage.setItem("email", email);
            }
            if (!localStorage.getItem("admin")) {
               var admin = $$ADMIN$$;
               localStorage.setItem("admin", admin);
            }
            if (!localStorage.getItem("main")) {
               var main = $$MAINTENANCE$$;
               localStorage.setItem("main", main);
            }

            if (localStorage.getItem("admin")==="1") {
               let menu_list = document.querySelector('#menu_list');
               let link = document.createElement('a');
                  link.setAttribute('href','ADMIN_DEMO_2.html');
                  menu_list.appendChild(link)
               let li = document.createElement('li');
                  li.innerHTML = "Administrator";
                  link.appendChild(li);
            }

            if (localStorage.getItem("main")==="1") {
               let menu_list = document.querySelector('#menu_list');
               let link = document.createElement('a');
                  link.setAttribute('href','maintenance.html');
                  menu_list.appendChild(link);
               let li = document.createElement('li');
                  li.innerHTML = "Maintenance";
                  link.appendChild(li);
            }

            //Add email in menu
            var email = localStorage.getItem("email");
            document.getElementById("email").innerHTML = email;

            //Log out function
            function logOut() {
               localStorage.removeItem("ssn");
               localStorage.removeItem("email");
               localStorage.removeItem("admin");
               localStorage.removeItem("main");
             localStorage.removeItem("token");
               window.location.replace("index.html");
            }

            //Function for retrieving room data and displaying it
            function getRooms() {
               var xhttp = new XMLHttpRequest();
               xhttp.open("POST", "/get_rooms", true);
               xhttp.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                     var rooms = JSON.parse(this.responseText);
                     if (rooms.error) {
                        console.log(rooms.error);
                        return;
                     }
                     let overview = document.querySelector('#room_overview');
                     for (let i = 0; i < rooms.length; i++) {
                        let room_container = document.createElement('div');
                           room_container.setAttribute('class','room_cont');
                           overview.appendChild(room_container);
                        let room = document.createElement('button');
                           room.setAttribute('type', 'button');
                           room.setAttribute('onclick', `getIns(${rooms[i].room_id})`);
                           room.setAttribute('class','room');
                           room.innerHTML = 'Room ' + rooms[i].room_id;
                           room.addEventListener("click", function() {
                              var current = document.getElementsByClassName("selected_room");
                              if (current[0] != undefined) {
                                 current[0].className = current[0].className.replace(" selected_room", "");
                              }
                              this.className += " selected_room";
                           })
                        room_container.appendChild(room);
                        let instruments = document.createElement('div');
                           instruments.setAttribute('id', `ins_${rooms[i].room_id}`);
                           instruments.setAttribute('class','ins');
                        room_container.appendChild(instruments);

                     }
                  }
               };
               var ssn = localStorage.getItem("ssn");
               var token = localStorage.getItem("token");
               xhttp.send(JSON.stringify({'ssn': ssn,token:token}));
            }


            //Function for showing instruments when a room button is clicked
            //instruments.json must contain insID and ins_description
            function getIns(room_id) {
               $(`#ins_${room_id}`).empty();
               $('.ins').empty();
               var xhttp = new XMLHttpRequest();
               xhttp.open("POST", "/get_instruments_in_room", true);
               xhttp.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                     var instrument = JSON.parse(this.responseText);
                     if (instrument.error) {
                        console.log(instrument.error);
                        return;
                     }
                     for (let i = 0; i < instrument.length; i++) {
                        let instruments = document.querySelector(`#ins_${room_id}`);
                        let ins = document.createElement('button');
                           ins.setAttribute('type', 'button');
                           ins.setAttribute('class','ins_button');
                           //Todays date
                           var today = new Date();
                           let current_year = today.getFullYear();
                           let current_month = today.getMonth();
                           let current_date = today.getDate();
                           let current_weekday = today.getDay();
                           //Set onclick funtion to calendar()
                           ins.setAttribute('onclick',`calendar(${current_year}, ${current_month}, ${current_date}, ${current_weekday}, ${instrument[i].ins_id}, '${instrument[i].description}', ${room_id})`);
                           ins.innerHTML = instrument[i].description;
                           ins.addEventListener("click", function() {
                              var current = document.getElementsByClassName("selected_ins");
                              if (current[0] != undefined) {
                                 current[0].className = current[0].className.replace(" selected_ins", "");
                              }
                              this.className += " selected_ins";
                           })
                        instruments.appendChild(ins);
                     }
                  }
               };
               var ssn = localStorage.getItem("ssn");
               var token = localStorage.getItem("token");
               xhttp.send(JSON.stringify({'room_id': room_id, 'ssn': ssn,token:token}));
            }


            //Add zero month or date
            function addZero(j) {
               if (j < 10) {
                  j = "0" + j;
               }
               return j;
            }

            //Change to previous week
            function next(year,month,last_date,insID,ins_desc,room_id) {
               let date = 0;
               let nmr_days = 32 - (new Date(year,month)).getDate();
               if (nmr_days === last_date) {
                  date = 1;
                  month = (month+1) % 12;
               } else {
                  date = last_date+1;
               }
               year = (month === 11) ? year + 1 : year;
               calendar(year,month,date,0,insID,ins_desc,room_id);
            }

            //Change to next week
            function previous(year,month,first_date,insID,ins_desc,room_id) {
               year = (month === 0) ? year - 1 : year;
               let date = 0;
               if (first_date === 1) {
                  date = 32 - (new Date(year,month-1)).getDate();
                  month = month-1;
               } else {
                  date = first_date-1;
               }
               calendar(year,month,date,6,insID,ins_desc,room_id);
            }

            //Showing calender
            function calendar(year,month,date,weekday,insID,ins_desc,room_id) {
               $("#info_text").empty();
               $("tbody").empty();
               $("thead").empty();
               $('#change_buttons').empty();
               $('#booking_form').empty();
               $(".success_message").empty();
               //Title of instrument
               let ins_text = document.querySelector('#info_text');
                  ins_text.innerHTML = "Room " + room_id + ': ' + ins_desc;
               //Choose tbody and thead elements by id
               let tbody = document.querySelector('#timeSlots');
               let thead = document.querySelector('#date');
               //Array for the days of the week
               let day_arr = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
               //Dates in a week
               let week_dates = [];
               //Days in current month
               let daysInMonth = 32 - (new Date(year, month, 32)).getDate();
               //Days in prevoius month
               let daysInPreviousMonth = 32 - new Date(year, month-1, 32).getDate();
               //Loop for creating table rows
               for (let j = 0; j < 12; j++) {
                  //Create table row for every booking hour
                  let tr = document.createElement('tr');
                  //For new month
                  let k = 1;
                  //For last month
                  let p = 0;
                  //Date object
                  let today = new Date();
                  //Loop for table columns, one for each day of the month
                  for (let i = 0; i < 7; i++) {
                     let td = document.createElement('td');
                        tr.appendChild(td);
                     let slotButton = document.createElement('button');
                        slotButton.setAttribute('class','slot');
                     //First row is table head
                     if (j == 0) {
                        let th = document.createElement('th');
                        //If the date is in the days of the month, display date
                        if (parseInt(date+(i-weekday)) <= daysInMonth && date >= 7) {
                           th.innerHTML = day_arr[i] + ' ' + parseInt(date+(i-weekday)) + '/' + parseInt(month+1);
                           week_dates[i] = [year,month,parseInt(date+(i-weekday))];
                        } else if (date < 7) {
                           if (weekday - i >= date) {
                              week_dates[i] = [year,month-1,parseInt(daysInPreviousMonth+p)];
                              th.innerHTML = day_arr[i] + ' ' + parseInt(daysInPreviousMonth+p) + '/' + month;
                              p = p-1;
                           } else {
                              week_dates[i] = [year,month,parseInt(date+(i-weekday))];
                              th.innerHTML = day_arr[i] + ' ' + parseInt(date+(i-weekday)) + '/' + parseInt(month+1);
                           }
                        } else {
                           th.innerHTML = day_arr[i] + ' ' + k + '/' + parseInt(month+2);
                           week_dates[i] = [year,month+1,k];
                           k = k+1;
                        }
                        //Mark todays date
                        if (week_dates[i][0] === today.getFullYear() && week_dates[i][1] === today.getMonth() && week_dates[i][2] === today.getDate()) {
                           th.classList.add("today");
                        }
                        thead.appendChild(th);
                     }
                     //Alter the time slots (no time slots for sunday and saturday)
                     if (i == 0 || i == 6) {
                        td.innerHTML = "";
                     } else {
                        //Date for time slot
                        let booking_date = week_dates[i][0] + "-" + addZero(week_dates[i][1]+1) + "-" + addZero(week_dates[i][2]);
                        //Start time for time slot
                        let start_ = addZero(7+j) + ':00:00';
                        //HttpRequest for checking available timeslots
                        //Dont know if it works
                        var xhttp = new XMLHttpRequest();
                        xhttp.open("POST", "/check_timeslot_available", true);
                        //Is it possile to have variables in the function..? Or is it unnecessary
                        xhttp.onreadystatechange = function() {
                           if (this.readyState == 4 && this.status == 200) {
                              var available = JSON.parse(this.responseText);
                              let today = new Date();
                              //Mark non-available slots
                              if (available.error || (week_dates[i][2] < today.getDate() && week_dates[i][1] === today.getMonth()) || today.getMonth() > week_dates[i][1] || (today.getHours() > 7+j && today.getDate() === week_dates[i][2] && today.getMonth() === week_dates[i][1] && today.getFullYear() === week_dates[i][0])) {
                                 slotButton.className += " non-available";
                                 slotButton.disabled = "disabled";
                              } else {
                                 slotButton.addEventListener("click", function() {
                                    var current = document.getElementsByClassName("active");
                                    if (current[0] != undefined) {
                                       current[0].className = current[0].className.replace(" active", "");
                                    }
                                    this.className += " active";
                                 })
                                 slotButton.setAttribute('onclick',`show_BookingForm(${year}, ${month}, ${date}, ${weekday}, ${7+j}, '${booking_date}', ${insID}, '${ins_desc}', ${room_id})`);
                              }
                           }
                        }
                        let start_timeslot = booking_date + ' ' + start_;
                        var ssn = localStorage.getItem("ssn");
                        var token = localStorage.getItem("token");
                        xhttp.send(JSON.stringify({'ssn': ssn, token:token, "ins_id": insID, "start_time": start_timeslot}));
                        slotButton.innerHTML = addZero(7+j) + ':00';
                        td.appendChild(slotButton);
                     }
                  }
                  tbody.appendChild(tr);
               }

               //Change-of-week buttons
               let change = document.querySelector('#change_buttons');
               let previous_week = document.createElement('button');
                  previous_week.setAttribute('class','change_week');
                  let first_date = week_dates[0][2];
                  let month_sun = week_dates[0][1];
                  previous_week.setAttribute('onclick',`previous(${year},${month_sun},${first_date},${insID},'${ins_desc}',${room_id})`)
                  previous_week.setAttribute('id','next');
                  previous_week.innerHTML = "Previous";
                  change.appendChild(previous_week);
               let next_week = document.createElement('button');
                  next_week.setAttribute('class','change_week');
                  let last_date = week_dates[6][2];
                  let month_sat = week_dates[6][1];
                  next_week.setAttribute('onclick',`next(${year},${month_sat},${last_date},${insID},'${ins_desc}',${room_id})`);
                  next_week.setAttribute("id","previous");
                  next_week.innerHTML = "Next";
                  change.appendChild(next_week);

               }

            //slotID is the start time
            function show_BookingForm(year,month,date,weekday,slotID,booking_date,insID,ins_desc,room_id) {
               //Creating a booking form with action: /reserve_instrument, which is sent to server with info of booking
               $("#booking_form").empty();
               $(".success_message").empty();
               document.querySelector("#booking_form").addEventListener("submit", formSubmit);
               let booking_form = document.querySelector('#booking_form')
                  booking_form.setAttribute('action','/reserve_instrument'); //FOR SERVER
                  booking_form.setAttribute('method','POST');
               //Label and input for date
               let date_input = document.createElement('input');
                  date_input.setAttribute('type','hidden');
                  date_input.setAttribute('name','date'); //
                  date_input.setAttribute('id','booking_date');
                  date_input.setAttribute("value",booking_date);
                  date_input.readOnly = true;
                  booking_form.appendChild(date_input);
               //Label and input for start time
               let start_label = document.createElement('label');
                  start_label.innerHTML = "Start time:"
                  start_label.setAttribute('for','start');
                  booking_form.appendChild(start_label);
               let start_time = document.createElement('input');
                  start_time.setAttribute('type','text');
                  start_time.setAttribute('name','start_time'); //
                  start_time.setAttribute('id','start');
                  start_time.setAttribute("value",`${booking_date} ${addZero(slotID)}:00:00`);
                  start_time.readOnly = true;
                  booking_form.appendChild(start_time);
               //Label and input for end time
               let end_label = document.createElement('label');
                  end_label.innerHTML = "End time:";
                  end_label.setAttribute('for','end');
                  booking_form.appendChild(end_label);
               let end_time = document.createElement('input');
                  end_time.setAttribute('type','text');
                  end_time.setAttribute('name','end_time'); //
                  end_time.setAttribute('id','end');
                  end_time.setAttribute('value',`${booking_date} ${addZero(slotID+1)}:00:00`);
                  end_time.readOnly = true;
                  booking_form.appendChild(end_time);
               //Label and input for notes
               let note_label = document.createElement('label');
                  note_label.innerHTML = "Notes:";
                  note_label.setAttribute('for','note');
                  booking_form.appendChild(note_label);
               let notes = document.createElement('textarea');
                  notes.setAttribute('name','notes'); //
                  notes.setAttribute('id','note');
                  booking_form.appendChild(notes);
               //Hidden field for InsID and ssn
               var ssn = localStorage.getItem("ssn");
               let ins_id = document.createElement('input');
                  ins_id.setAttribute('type','hidden');
                  ins_id.setAttribute('name','ins_id');
                  ins_id.setAttribute('value',`${insID}`);
                  booking_form.appendChild(ins_id);
               let ssn_input = document.createElement('input');
                  ssn_input.setAttribute('type','hidden');
                  ssn_input.setAttribute('name','ssn');
                  ssn_input.setAttribute('value',`${ssn}`);
                  booking_form.appendChild(ssn_input);
               //Submit button, action /booking is performed
               let submit = document.createElement('input');
                  submit.setAttribute("type","submit");
                  submit.setAttribute("value","Submit booking");
                  booking_form.appendChild(submit);

               //Successful or unsuccessfull booking
               function formSubmit(e) {
                  var url = '/reserve_instrument';
                  var request = new XMLHttpRequest();
                  request.open('POST', url, true);
                  //Successful booking
                  request.onload = function() {
                     var response = JSON.parse(this.responseText);
                     if (response.error) {
                        calendar(year,month,date,weekday,insID,ins_desc,RoomID);
                        let schedule = document.querySelector('#schedule');
                        let success = document.createElement('div');
                        schedule.appendChild(success);
                           success.setAttribute('class','success_message');
                        let image = document.createElement('img');
                           image.setAttribute('src','./unsuccessful_booking.png');
                           image.setAttribute('width','50px');
                           image.setAttribute('height','50px');
                           image.setAttribute('class','success_image')
                        success.appendChild(image);
                        let message = document.createElement('p');
                           message.innerHTML = response.error.message;
                        success.appendChild(message);
                     } else {
                        calendar(year,month,date,weekday,insID,ins_desc,RoomID);
                        let schedule = document.querySelector('#schedule');
                        let success = document.createElement('div');
                        schedule.appendChild(success);
                           success.setAttribute('class','success_message');
                        let image = document.createElement('img');
                           image.setAttribute('src','./success_booking.png');
                           image.setAttribute('width','50px');
                           image.setAttribute('height','50px');
                           image.setAttribute('class','success_image')
                        success.appendChild(image);
                        let message = document.createElement('p');
                           message.innerHTML = `Your reservation was successful <br> ${booking_date} <br> ${addZero(slotID)}:00 - ${addZero(slotID+1)}:00`;
                        success.appendChild(message);
                        }
                     }
                  }
                  //Request failed
                  request.onerror = function() {
                     calendar(year,month,date,weekday,insID,ins_desc,room_id);
                     let schedule = document.querySelector('#schedule');
                     let success = document.createElement('div');
                     schedule.appendChild(success);
                        success.setAttribute('class','success_message');
                     let image = document.createElement('img');
                        image.setAttribute('src','./unsuccessful_booking.png');
                        image.setAttribute('width','50px');
                        image.setAttribute('height','50px');
                        image.setAttribute('class','success_image')
                     success.appendChild(image);
                     let message = document.createElement('p');
                        message.innerHTML = "Error when reserving timeslot";
                     success.appendChild(message);
                  }
                  request.send($('#booking_form').serialize()+`&token=${localStorage.getItem("token")}&ssn=${localStorage.getItem("ssn")}`);
                  e.preventDefault();
                  document.querySelector("#booking_form").removeEventListener("submit", formSubmit);
               };

            }





            getRooms();

         </script>

      </main>

   </body>
</html>
