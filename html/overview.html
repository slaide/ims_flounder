<!DOCTYPE html>
<html lang="eng">
   <head>
      <title>Room overview</title>
      <meta charset="UTF-8">
      <link rel="stylesheet" type="text/css" href="./reset.css">
      <link rel="stylesheet" type="text/css" href="./flounder.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
   </head>

   <body>
      <!--Navigation menu for users-->
      <nav class="menu">
         <ul>
            <li><a href="#">Book an instrument</a></li>
            <li><a href="#">My Schedule</a></li>
            <li><a href="#">Administrator</a></li>
            <li><a href="#">Maintenance</a></li>
         </ul>
      </nav>
      
      <main id="overview_cont">
         <div class="grid">
            <h1 class="overview_title">Room overview</h1>
            <div id="room_overview"></div>
         </div>

         <div class="grid">
            <h1 class="overview_title">Book an instrument</h1>
            <div id="schedule">
               <p id="info_text">Select a room and instrument under room overview</p>
               <div id="change_buttons"></div>
               <table id="ins_table">
                  <thead id="date"></thead>
                  <tbody id="timeSlots"></tbody>
               </table>
               <form id="booking_form"></form>
            </div>

         </div>


         <script>

            function getRooms() {
               var xhttp = new XMLHttpRequest();
               xhttp.open("GET", "/get_rooms", true);
               xhttp.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                     var rooms = JSON.parse(this.responseText);
                     let overview = document.querySelector('#room_overview');
                     for (let i = 0; i < rooms.length; i++) {
                        let room_container = document.createElement('div');
                           overview.appendChild(room_container);
                        let room = document.createElement('button');
                           room.setAttribute('type', 'button');
                           room.setAttribute('onclick', `getIns('${rooms[i].RoomID}')`);
                           room.setAttribute('class','room');
                           room.innerHTML = 'Room ' + rooms[i].RoomCode;
                        room_container.appendChild(room);
                        let instruments = document.createElement('div');
                           instruments.setAttribute('id', `ins_${rooms[i].RoomID}`);
                           instruments.setAttribute('class','ins');
                        room_container.appendChild(instruments);

                     }
                  }  
               };
               xhttp.send();
            }

            
            //Function for showing instruments when a room button is clicked
            //instruments.json must contain insID and ins_description
            function getIns(RoomID) {
               $(`#ins_${RoomID}`).empty();
               $('.ins').empty();
               var xhttp = new XMLHttpRequest();
               xhttp.open("POST", "/get_machines_in_room", true);
               xhttp.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                     var instrument = JSON.parse(this.responseText);
                     for (let i = 0; i < instrument.length; i++) {
                        let instruments = document.querySelector(`#ins_${RoomID}`);
                        let ins = document.createElement('button');
                           ins.setAttribute('type', 'button');
                           //Add insID in getSched()
                           ins.setAttribute('onclick',`getSched('${instrument[i].description}, ${instrument[i].insID}')`);
                           ins.innerHTML = instrument[i].description;
                        instruments.appendChild(ins);
                     }
                  }
               };
               xhttp.send(JSON.stringify({'RoomID': RoomID}));
            }

            //Function for displaying instrument booking options/instrument schedule
            //All booking information for one instrument that is choosen
            //Do we want a display of the weekly schedule, or many weeks
            function getSched(ins_desc, insID) {
               $("#info_text").empty();
               $("#date").empty();
               $("tbody").empty();
               $('#change_buttons').empty();
               var xhttp = new XMLHttpRequest();
               xhttp.open("POST", "/ins_bookings", true);
               xhttp.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                     var bookings = JSON.parse(this.responseText);
                     let schedule = document.querySelector('#schedule');

                     //Todays date
                     var today = new Date();
                     let UTCyear = today.getUTCFullYear();
                     //OBS!!! January = 0, February = 1... -> change to January = 1, February = 2 for display and add 0 using addZero function
                     let UTCmonth = today.getUTCMonth();
                     let UTCdate = today.getUTCDate();
                     //Sunday = 0, Monday = 1... -> change to Monday = 0, Tuesday = 1
                     let weekday = today.getUTCDay()-1;

                     //Title end up in the bottom...and many times??
                     let ins_title = document.createElement('h2');
                        ins_title.innerHTML = ins_desc;
                        schedule.appendChild(ins_title);
                     
                     //Change-of-week buttons
                     let change = document.querySelector('#change_buttons');
                     let previous_week = document.createElement('button');
                        previous_week.setAttribute('class','change_week');
                        previous_week.setAttribute(onclick,`previous(${UTCyear,UTCmonth,UTCdate})`);
                        previous_week.setAttribute('id','next');
                        previous_week.innerHTML = "Previous";
                        change.appendChild(previous_week);
                     let next_week = document.createElement('button');
                        next_week.setAttribute('class','change_week');
                        next_week.setAttribute('onclick',`next(${UTCyear,UTCmonth,UTCdate})`);
                        next_week.setAttribute("id","previous");
                        next_week.innerHTML = "Next";
                        change.appendChild(next_week);

                     //Choose tbody and thead elements by id
                     let tbody = document.querySelector('#timeSlots');
                     let thead = document.querySelector('#date');
                     //Array for the days of the week 
                     let day_arr = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
                     //Loop for creating table rows
                     for (let j = 0; j < 12; j++) {
                        //Create table row for every booking hour 
                        let tr = document.createElement('tr');
                     for (let i = 0; i < 5; i++) {
                        if (j == 0) {
                           let th = document.createElement('th');
                              th.innerHTML = day_arr[i];
                              thead.appendChild(th);
                        }
                        let td = document.createElement('td');
                           tr.appendChild(td);
                        let slotButton = document.createElement('button');
                        //Dont know if working
                        if (i < weekday) {
                           slotButton.setAttribute('class','non-available');
                        }
                        //....
                           slotButton.setAttribute('class','slot')
                           slotButton.setAttribute('onclick',`show_BookingForm(${7+j}, ${i})`)
                           slotButton.innerHTML = (7+j) + ':00';
                           td.appendChild(slotButton);     
                     }
                     tbody.appendChild(tr);

                     }  
                  }
               }
               //Send insID
               xhttp.send(JSON.stringify({'insID':insID}));
            }

            //Add zero month or date
            function addZero(j) {
               if (j < 10) {
                  j = "0" + j;
               }
               return j;
            }

            //Change to previous week
            function next(currentYear,currentMonth,currentDate) {
               currentYear = (currentMonth === 11) ? currentYear + 1 : currentYear;
               currentMonth = (currentMonth + 1) % 12;
               //Change date
               return [currentYear,currentMonth,currentDate];
               
            }

            //Change to next week
            function previous(currentYear,currentMonth,currentDate) {
               currentYear = (currentMonth === 0) ? currentYear - 1 : currentYear;
               currentMonth = (currentMonth === 0) ? 11 : currentMonth - 1;
               //Change date
               return [currentYear,currentMonth,currentDate];
            }


            //dateID range from 0 to 4 and is index for day of the week, Monday=0, Tuesday=1...
               // OBS!!! Should be changed to true date
            //slotID is the start time
            function show_BookingForm(slotID,date) {
               //Creating a booking form with action: /booking, which is sent to server with info of booking
               $("#booking_form").empty();
               let booking_form = document.querySelector('#booking_form')
                  booking_form.setAttribute('action','/booking'); //FOR SERVER
                  booking_form.setAttribute('method','POST');
               //Label and input for date
               let date_label = document.createElement('label');
                  date_label.innerHTML = "Date";
                  date_label.setAttribute('for','booking_date');
                  booking_form.appendChild(date_label);
               let date_input = document.createElement('input');
                  date_input.setAttribute('type','text');
                  date_input.setAttribute('name','date'); //
                  date_input.setAttribute('id','booking_date');
                  //OBS!!! Change value to accurate date//
                  date_input.setAttribute("value","2021-09-12");
                  date_input.readOnly = true;
                  booking_form.appendChild(date_input);
               //Label and input for start time
               let start_label = document.createElement('label');
                  start_label.innerHTML = "Start time"
                  start_label.setAttribute('for','start');
                  booking_form.appendChild(start_label);
               let start_time = document.createElement('input');
                  start_time.setAttribute('type','text');
                  start_time.setAttribute('name','start_time'); //
                  start_time.setAttribute('id','start');
                  start_time.setAttribute("value",`${slotID}:00`);
                  start_time.readOnly = true;
                  booking_form.appendChild(start_time);
               //Label and input for end time
               let end_label = document.createElement('label');
                  end_label.innerHTML = "End time";
                  end_label.setAttribute('for','end');
                  booking_form.appendChild(end_label);
               let end_time = document.createElement('input');
                  end_time.setAttribute('type','text');
                  end_time.setAttribute('name','end_time'); //
                  end_time.setAttribute('id','end');
                  end_time.setAttribute('value',`${slotID+1}:00`);
                  end_time.readOnly = true;
                  booking_form.appendChild(end_time);
               //Label and input for notes
               let note_label = document.createElement('label');
                  note_label.innerHTML = "Notes";
                  note_label.setAttribute('for','note');
                  booking_form.appendChild(note_label);
               let notes = document.createElement('textarea');
                  notes.setAttribute('name','notes'); //
                  notes.setAttribute('id','note');
                  booking_form.appendChild(notes);
               //Submit button, action /booking is performed
               let submit = document.createElement('input');
                  submit.setAttribute("type","submit");
                  submit.setAttribute("value","Submit");
                  booking_form.appendChild(submit);

               
            }

            getRooms();             

         </script>

      </main>

   </body>
</html>