<!DOCTYPE html>
<html lang="eng">
  <head>
    <title>Maintenence</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="./reset.css">
    <link rel="stylesheet" type="text/css" href="./flounder.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  </head>

  <body>
    <!--Navigation menu for users-->
    <nav class="menu">
         <img src="./favicon.ico" width="256" height="256">
         <ul id="menu_list">
            <a href="./overview.html"><li>Book an instrument</li></a>
            <a href="./my_schedule.html"><li>My Bookings</li></a>
         </ul>
         <a id="log_out" onclick="logOut()">Log out</a>
        <div id="email"></div>
      </nav>

    <main id="whole_page">
      <div id="select_ins">
        <h1>Select instrument</h1>
          <select id="instrument_menu"  onChange="javascript:selected_ins(this);" name="instrument_menu">
            <option hidden disabled selected value >-- Select instrument --</option>
          </select>
        <div id="maintenance_form_div">
        </div>
      </div>
      <div id="maintenance_overview">
        <h1>Maintenance entries</h1>
        <div id="see_notes">
        </div>
      </div>

      <script>
         var ssn = localStorage.getItem("ssn");
         var email = localStorage.getItem("email");
         document.getElementById("email").innerHTML = email;
         if (localStorage.getItem("admin")==="1") {
               let menu_list = document.querySelector('#menu_list');
               let link = document.createElement('a');
                  link.setAttribute('href','ADMIN_DEMO_2.html');
                  menu_list.appendChild(link)
               let li = document.createElement('li');
                  li.innerHTML = "Administrator";
                  link.appendChild(li);
            }
          if (localStorage.getItem("main")==="1") {
               let menu_list = document.querySelector('#menu_list');
               let link = document.createElement('a');
                  link.setAttribute('href','maintenance.html');
                  menu_list.appendChild(link);
               let li = document.createElement('li');
                  li.innerHTML = "Maintenance";
                  link.appendChild(li);
            }

          function logOut() {
               localStorage.removeItem("ssn");
               localStorage.removeItem("email");
               localStorage.removeItem("admin");
               localStorage.removeItem("main");
               localStorage.removeItem("token");
                window.location.replace("index.html");
            }

          function sort_drop_down(){
            var drop_down, switching, i, x, y, shouldSwitch;
            drop_down = document.getElementById('instrument_menu');
            switching = true;
            
            while (switching) {
              switching = false;              
              for (i=1; i < (drop_down.length-2); i++) {
                shouldSwitch = false;
                x = drop_down[i].innerHTML;
                y = drop_down[i+1].innerHTML;
                x = x.match(/\d+/)[0];
                y = y.match(/\d+/)[0];
                if (x>y) {
                  shouldSwitch = true;
                  break;
                }
              }
              if (shouldSwitch) {
                drop_down[i].insertBefore(drop_down[i+1], drop_down[i]);
                switching = true;
              }
            }
          }


         function getRooms() {
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/get_rooms", true);
            xhttp.onreadystatechange = function() {
               if (this.readyState == 4 && this.status == 200) {
                  var rooms = JSON.parse(this.responseText);
                  if (rooms.error) {
                     console.log(rooms.error)
                     return;
                  }
                  let ins_menu = document.querySelector("#instrument_menu");
                  for (let i = 0; i < rooms.length; i++) {
                    populateMenu(rooms[i].room_id);
                     //let room_alt = document.createElement('option');
                     //room_alt.innerHTML = 'Room ' + rooms[i].room_id;
                     //ins_menu.appendChild(room_alt);
                     //room_alt.setAttribute('class', 'room_alt');
                     //let room_name = document.createTextNode(rooms[i]);
                     //room_alt.appendChild(room_name);
                  }
               }
            };
          var token = localStorage.getItem("token");
          var ssn = localStorage.getItem("ssn");
          xhttp.send(JSON.stringify({'ssn': ssn,token:token}));
          setTimeout(sort_drop_down, 100);
         }

         function populateMenu(room_id) {
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "/get_instruments_in_room", true);
            xhttp.onreadystatechange = function() {
              if (this.readyState == 4 && this.status == 200) {
                var instruments = JSON.parse(this.responseText);
                if (instruments.error) {
                  console.log(instruments.error);
                  return;
                }
                let ins_menu = document.querySelector("#instrument_menu");
                for (let i = 0; i < instruments.length; i++) {
                  let ins_alt = document.createElement('option');
                  //alert(instruments[i].ins_id);
                  //ins_alt.className = instruments[i].ins_id;
                  ins_alt.setAttribute("value", instruments[i].ins_id);
                  ins_alt.innerHTML = 'Room ' + room_id + ": " + instruments[i].description;
                  ins_menu.appendChild(ins_alt);
                  //show_maintanance(instruments[i].ins_id);
                  }
            }
         };
         var token = localStorage.getItem("token");
         var ssn = localStorage.getItem("ssn");
         xhttp.send(JSON.stringify({'room_id': room_id, 'ssn': ssn,token:token}));
        }

        function selected_ins(ins_id_input) {
          var ins_id = ins_id_input[ins_id_input.selectedIndex].value;

          let form_div = document.querySelector("#maintenance_form_div");
          form_div.innerHTML = "";
          let form_title = document.createElement('h1');
          form_title.setAttribute('id', 'form_title');
          form_title.innerHTML = "New maintenance entry";
          let form_main = document.createElement("form");
          form_main.setAttribute('id', 'maintenance_form');
          let arg_str = 'javascript:add_maintenance(' + ins_id.toString() + ');'
          form_main.setAttribute('action', arg_str);

          let text_date = document.createElement("h1");
          text_date.innerHTML = "Date";
          let input_date = document.createElement("input");
          input_date.setAttribute('type', 'DateTime-local');
          input_date.setAttribute('id', 'form_date');
          let error_date = document.createElement("h5");
          error_date.setAttribute("id", "error_date");
          //error_date.innerHTML = "";

          let text_status = document.createElement("h1");
          text_status.innerHTML = "Status";
          let input_status = document.createElement("input");
          input_status.setAttribute('type', 'text');
          input_status.setAttribute('id', 'form_status');

          let text_note = document.createElement("h1");
          text_note.innerHTML = "Note";
          let input_note = document.createElement("input");
          input_note.setAttribute('type', 'text');
          input_note.setAttribute('id', 'form_note');

          let submit_button = document.createElement('input');
          submit_button.setAttribute('type', 'submit');
          submit_button.setAttribute('value', 'submit form');

          let confirmation = document.createElement("h1");
          confirmation.setAttribute('id', 'confirmation');

          form_main.appendChild(text_date);
          form_main.appendChild(error_date);
          form_main.appendChild(input_date);
          form_main.appendChild(text_status);
          form_main.appendChild(input_status);
          form_main.appendChild(text_note);
          form_main.appendChild(input_note);
          form_main.appendChild(document.createElement('br'));
          form_main.appendChild(submit_button);
          form_main.appendChild(confirmation);
          form_div.appendChild(form_title);
          form_div.appendChild(form_main);

          // Seeing old notes
          let see_notes_div = document.querySelector("#see_notes");
          see_notes_div.innerHTML = "";
          let table_notes = document.createElement("table");
          table_notes.setAttribute('id', 'notes_table');
          see_notes_div.appendChild(table_notes);
          //test_print();//Remove when show_mantenance is working
          show_maintenance(ins_id);
          
          //add_maintenance(ins_id);
        }

        function show_maintenance(ins_id) {
          var xhttp = new XMLHttpRequest();
          xhttp.open("POST", "/get_maintenance", true);
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              var instrument_notes = JSON.parse(this.responseText);
              if (instrument_notes.error) {
                console.log(this.responseText);
                alert("Error");
                return;
              }
              let table_element = document.querySelector("#notes_table");
              table_element.innerHTML = "";
              let table_header = document.createElement("tr");
              let table_header_time = document.createElement("th");
              table_header_time.innerHTML = "Date & Time";
              let table_header_status = document.createElement("th");
              table_header_status.innerHTML = "Status";
              let table_header_note = document.createElement("th");
              table_header_note.innerHTML = "Notes";
              table_header.appendChild(table_header_time);
              table_header.appendChild(table_header_status);
              table_header.appendChild(table_header_note);
              table_element.appendChild(table_header);
              for (let i = 0; i < instrument_notes.length; i++) {
                let table_entry = document.createElement("tr");
                let table_time = document.createElement("td");
                //table_time.innerHTML = instrument_notes[i].date_time;
                ins_date = instrument_notes[i].date_time;
                ins_date = ins_date.substring(0, 16);
                ins_date = ins_date.replace('T', ' ');
                hour = ins_date.substring(11, 13);
                hour = Number(hour)+1;

                if (hour == -1) {
                  hour = 23;
                }
                hour = hour.toString();
                if (hour.length == 1) {
                  hour = 0 + hour;
                }
                ins_date = ins_date.substring(0, 11) + hour + ins_date.substring(13, 16);
                //table_time.innerHTML = ins_date;

                //date_hour = ins_date.substring(11, 12);
                //alert(date_hour);
                //date_hour = date_hour + 1;
                //alert(date_hour);
                //ins_date = ins_date.substring(0, 11) + date_hour + ins_date.substring(12, 16);
                table_time.innerHTML = ins_date;
                let table_status = document.createElement("td");
                table_status.innerHTML = instrument_notes[i].status;
                let table_note = document.createElement("td");
                table_note.innerHTML = instrument_notes[i].notes;
                table_entry.appendChild(table_time);
                table_entry.appendChild(table_status);
                table_entry.appendChild(table_note);
                table_element.appendChild(table_entry);

              }
            } else if(this.status == 200){
              //alert("error2");
            } else if(this.readyState == 4) {
              //alert("error3");
            } else {
              //alert("error4");
            }
          };
          var token = localStorage.getItem("token");
          var ssn = localStorage.getItem("ssn");
          xhttp.send(JSON.stringify({'ins_id': ins_id,'ssn': ssn,token:token}));
          setTimeout(sort_table, 50);
        }

        function compare_date(date1, date2) {
          if(date1.substring(0,4)<date2.substring(0,4)){
            return true;
          } else if(date1.substring(0,4)>date2.substring(0,4)){
            return false;
          } else if(date1.substring(5,7)<date2.substring(5,7)){
            return true;
          } else if(date1.substring(5,7)>date2.substring(5,7)){
            return false;
          } else if(date1.substring(8,10)<date2.substring(8,10)){
            return true;
          } else if(date1.substring(8,10)>date2.substring(8,10)){
            return false;
          } else if(date1.substring(11,13)<date2.substring(11,13)){
            return true;
          } else if(date1.substring(11,13)>date2.substring(11,13)){
            return false;
          } else if(date1.substring(14,16)<date2.substring(14,16)){
            return true;
          } else if(date1.substring(14,16)>date2.substring(14,16)){
            return false;
          }
          return false;
        }

        function sort_table() {
          var table, rows, switching, i, x, y, shouldSwitch;
          table = document.getElementById('notes_table');
          switching = true;
          
          while (switching) {
            switching = false;
            rows = table.rows;
            for (i=1; i < (rows.length-1); i++) {
//              alert("go: " + i);
              shouldSwitch = false;
              x = rows[i].getElementsByTagName("td")[0];
              y = rows[i+1].getElementsByTagName("td")[0];
              if (compare_date(x.innerHTML, y.innerHTML)) {
                shouldSwitch = true;
                break;
              }
            }
            if (shouldSwitch) {
              rows[i].parentNode.insertBefore(rows[i+1], rows[i]);
              switching = true;
            }
          }
        }

        function add_maintenance(ins_id) {
          let date_obj = document.getElementById("form_date").value;
          let date = date_obj.replace('T', ' ');
          let status = document.getElementById("form_status").value;
          let note = document.getElementById("form_note").value;

          var today = new Date();
          var dd = String(today.getDate());
          var mm = 1+today.getMonth();
          var yyyy = today.getFullYear();
          //alert(date.substring(5, 7));
          if (yyyy<date.substring(0, 4)) {
            let error_date = document.getElementById("error_date");
            let confirmation = document.querySelector("#confirmation");
            error_date.innerHTML = "Invalid year";
            confirmation.innerHTML = "";
            return false;
          } else if(yyyy == date.substring(0, 4) && mm < Number(date.substring(5, 7))){
            let error_date = document.getElementById("error_date");
            let confirmation = document.querySelector("#confirmation");
            error_date.innerHTML = "Invalid month";
            confirmation.innerHTML = "";
            return false;
          } else if (yyyy == date.substring(0, 4) && mm == date.substring(5, 7) && dd < Number(date.substring(8, 10))) {
            let error_date = document.getElementById("error_date");
            let confirmation = document.querySelector("#confirmation");
            error_date.innerHTML = "Invalid day";
            confirmation.innerHTML = "";
            return false;
          }


          //alert(InsID);
          //alert(date + status + note);

          var xhttp = new XMLHttpRequest();
          xhttp.open("POST", "/add_maintenance", true);
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              var maintenance_for_ins = JSON.parse(this.responseText);
              if (maintenance_for_ins.error) {
                console.log(maintenance_for_ins.error);
                return;
              }
              let error_date = document.querySelector("#error_date");
              error_date.innerHTML = "";
              let confirmation = document.querySelector("#confirmation");
              confirmation.innerHTML = "Maintenance note added";
              //show_maintenance(InsID);
            }
          };
          //alert("calling");
          var token = localStorage.getItem("token");
          var ssn = localStorage.getItem("ssn");
          xhttp.send(JSON.stringify({'date_time': date, 'status': status, 'notes': note, 'ssn': ssn, 'ins_id': ins_id, token:token}));
          setTimeout(function() {show_maintenance(ins_id)}, 50);
//          show_maintenance(ins_id);
        }

        function test_print() {
          //var ins_idXX = in_str[in_str.selectedIndex].value;
          //document.querySelector('#lmao').innerHTML = ins_idXX;

          let table_element = document.querySelector("#notes_table");
          table_element.innerHTML = "";
          let table_header = document.createElement("tr");
          let table_header_time = document.createElement("th");
          table_header_time.innerHTML = "Date & Time";
          let table_header_status = document.createElement("th");
          table_header_status.innerHTML = "Status";
          let table_header_note = document.createElement("th");
          table_header_note.innerHTML = "Notes";
          table_header.appendChild(table_header_time);
          table_header.appendChild(table_header_status);
          table_header.appendChild(table_header_note);
          table_element.appendChild(table_header);

          let table_entry = document.createElement("tr");
          let table_time = document.createElement("th");
          table_time.innerHTML = "2021/03/03 00:20";
          let table_status = document.createElement("th");
          table_status.innerHTML = "Working";
          let table_note = document.createElement("th");
          table_note.innerHTML = "Added a new lamp, all is working";
          table_entry.appendChild(table_time);
          table_entry.appendChild(table_status);
          table_entry.appendChild(table_note);
          table_element.appendChild(table_entry);

        }

        getRooms();

        //hello_world();
      </script>
    </main>

  </body>
</html>
