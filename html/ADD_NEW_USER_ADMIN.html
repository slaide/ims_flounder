<!DOCTYPE html>
<html lang="eng">
    <head>
    <!--Title of the page and CSS code -->

      <title>Add new user</title>
      <meta charset="UTF-8">
      <link rel="stylesheet" type="text/css" href="./reset.css">
      <link rel="stylesheet" type="text/css" href="./flounder.css">
      <link rel="stylesheet" type="text/css" href="./admin.css">
      <link rel="preconnect" href="https://fonts.gstatic.com">
      <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>

    <body>

        <!--Navigation to the other pages-->
        <nav class="menu">
            <img src="./favicon.ico" width="256" height="256">
            <ul id="menu_list">
               <a href="./overview.html"><li>Book an instrument</li></a>
               <a href="./my_schedule.html"><li>My Bookings</li></a>
               <a href="./ADMIN_DEMO_2.html"><li>Administrator</li></a>         
            </ul>
            
            <!--log out button-->
            <a id="log_out" href="#" onclick="logOut()">Log out</a>
            <div id="email"></div>
        </nav>

        <!--Form to add the new user-->
        <div id="add_user_div">
          <form action="/add_user" method="POST" id="add_user_form"> 
              <br><h2>Please provide the following information:</h2>


              <br><br><label for="first_name">First name:</label>
              <input type="text" name="first_name"> 


              <br><br><label for="password">Password:</label>
              <input type="text" name="password"> 

              <br><br><label for="email">E-mail:</label>
              <input type="email" name="email" required>



              <br><br><label for="last_name">Last name:</label>
              <input type="text" name="last_name">

              <br><br><label for="phone_number">Phone number:</label>
              <input type="numeric" name="phone_number">


              <br><br><label for="ssn_user">SSN:</label>
              <input type="numeric" name="ssn_user">


              <br><br><label for="special_rights">Special rights:</label>
              <select name="special_rights" id="special_rights">
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                </select>

              <br><br><label for="admin">Administrator:</label>
              <select name="admin" id="admin">
                  <option value="1">Yes</option>
                  <option value="0">No</option>
                </select>

              <br><br><label for="maintenance">Maintenance:</label>
              <select name="maintenance" id="maintenance">
                <option value="1">Yes</option>
                <option value="0">No</option>
                </select>


              <br><br><label for="immunocompromised">Immunocompromised:</label>
              <select name="immunocompromised" id="immunocompromised">
                <option value="1">Yes</option>
                <option value="0">No</option>
                </select>

              <br><input class="button" type="submit" value="Confirm">

          </form>
      </div>


      <!--Scripts-->
      <script>
        if (localStorage.getItem("main")==="1") {
                let menu_list = document.querySelector('#menu_list');
                let link = document.createElement('a');
        link.setAttribute('href','maintenance.html');
        menu_list.appendChild(link);
        let li = document.createElement('li');
            li.innerHTML = "Maintenance";
            link.appendChild(li);
        }
           var form = document.querySelector("#add_user_form");

           getSSN_getToken(form);

           function getSSN_getToken(form){
              var input_SSN = document.createElement("input");
              input_SSN.setAttribute("type","hidden");
              input_SSN.setAttribute("name","ssn");
              input_SSN.setAttribute("value",`${localStorage.getItem("ssn")} `);

              form.appendChild(input_SSN);

              var input_token = document.createElement("input");
              input_token.setAttribute("type","hidden");
              input_token.setAttribute("name","token");
              input_token.setAttribute("value",`${localStorage.getItem("token")} `);

              form.appendChild(input_token);

           }

           //To display the e-mail of current user 
           var email = localStorage.getItem("email");
           document.getElementById("email").innerHTML = email;

           //Listner for submit function and returns error text in the log if error occurs
           document.querySelector("#add_user_form").addEventListener("submit", formSubmit);

           function formSubmit(e) {
                       var xhttp = new XMLHttpRequest();
                       xhttp.open("POST","/add_user",true);
                       xhttp.onload = function () {
                           if(JSON.parse(this.responseText).error) {
                             if(JSON.parse(this.responseText).error.token_expired){
                               logOut();
                             } else {
                              console.log(JSON.parse(this.responseText).error);
                              window.alert("ERROR: " + JSON.parse(this.responseText).error.message);
                              window.location.reload(); 
                               }
                           } else {
                           window.location.href = "ADMIN_DEMO_2.html";
                           }
                       }
                       xhttp.onerror = function() {
                           window.alert("Request failed");
                       }
                       xhttp.send($("#add_user_form").serialize());
                       e.preventDefault();
                       document.querySelector("#add_user_form").removeEventListener("submit", formSubmit);
                   } 

        //Log out function
        function logOut() {
            localStorage.removeItem("ssn");
            localStorage.removeItem("email");
            localStorage.removeItem("admin");
            localStorage.removeItem("main");
            localStorage.removeItem("token");
            window.location.replace("index.html");
        }

    </script>
    </body>

</html>