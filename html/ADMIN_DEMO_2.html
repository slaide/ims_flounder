<!DOCTYPE html>
<html> 
    <head>
        <title>Administrator panel</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="./reset.css">
        <link rel="stylesheet" type="text/css" href="./flounder.css">
        <link rel="stylesheet" type="text/css" href="./admin.css">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>


    <body>

        <nav class="menu">
            <img src="./favicon.ico" width="256" height="256">
            <ul id="menu_list">
               <a href="./overview.html"><li>Book an instrument</li></a>
               <a href="./my_schedule.html"><li>My Bookings</li></a>
               <a href="#"><li>Administrator</li></a>
            </ul>
            <a id="log_out" href="#" onclick="logOut()">Log out</a>
            <div id="email"></div>
        </nav>

        <main>
        
            <div id="button_container">
                <h1>Add objects to database</h1>
                <button class="add_button" onclick="document.location='ADD_NEW_USER_ADMIN.html'">Add a new <strong>user</strong></button>
                <button class="add_button" onclick="document.location='ADD_NEW_INSTRUMENT_ADMIN.html'">Add a new <strong>instrument</strong></button>
                <button class="add_button" onclick="document.location='ADD_NEW_ROOM_ADMIN.html'">Add a new <strong>room</strong></button> 
            </div>

            <div id="remove_container">
                <div class="remove_room">
                    <h1>Remove rooms</h1>
                </div>
                <div class="remove_ins">
                    <h1>Remove instruments</h1>
                </div>
            </div>

            <div id="user_display">
                <h1>User overview</h1>
                <table id="user_table">
                    <thead id="user_head"></thead>
                    <tbody id="user_body"></tbody>
                </table>
            </div>

            <script>

                //Add maintenance navigering if maintenance personell
                if (localStorage.getItem("main")==="1") {
                let menu_list = document.querySelector('#menu_list');
                let link = document.createElement('a');
                    link.setAttribute('href','maintenance.html');
                    menu_list.appendChild(link);
                let li = document.createElement('li');
                    li.innerHTML = "Maintenance";
                    link.appendChild(li);
                }

                //Add email in menu
                var email = localStorage.getItem("email");
                document.getElementById("email").innerHTML = email;

                //Log out function
                function logOut() {
                    localStorage.removeItem("ssn");
                    localStorage.removeItem("email");
                    localStorage.removeItem("admin");
                    localStorage.removeItem("main");
                    window.location.replace("index.html");
                }

                //Function for displaying rooms
                function getRooms() {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "/get_rooms_admin", true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var rooms = JSON.parse(this.responseText);
                            if (rooms.error) {
                                console.log(rooms.error);
                            return;
                            }
                            //Create form for removing room, action: /remove_room
                            let cont = document.querySelector('.remove_room');
                            let form = document.createElement('form');
                                form.setAttribute("action","/remove_room");
                                form.setAttribute("method","POST");
                                form.setAttribute('id','remove_room_form');
                            cont.appendChild(form);
                            form.addEventListener("submit", formSubmit);
                            let select_room = document.createElement('select');
                                select_room.setAttribute("name","RoomID");
                            form.appendChild(select_room);
                            for (let i = 0; i < rooms.length; i++) {
                                let option = document.createElement('option');
                                    option.setAttribute("value",`${rooms[i].RoomID}`);
                                    option.innerHTML = `Room ${rooms[i].RoomID}`;
                                select_room.appendChild(option);
                            }
                            let submit = document.createElement('input');
                                submit.setAttribute('type','submit');
                                submit.setAttribute('value','Remove room');
                            form.appendChild(submit);
                            let input_ssn = document.createElement('input');
                                input_ssn.setAttribute("type","hidden");
                                input_ssn.setAttribute("name","ssn");
                                input_ssn.setAttribute("value",`${ssn}`);
                            form.appendChild(input_ssn);

                            //Redirecting to admin page when submitting removal
                            function formSubmit(e) {
                                var url = '/remove_room';
                                var request = new XMLHttpRequest();
                                request.open('POST', url, true);
                                let remove_container = document.querySelector(".remove_room");
                                let message = document.createElement('p');
                                request.onload = function () {
                                    if (JSON.parse(this.responseText).error) {
                                        console.log(JSON.parse(this.responseText).error);
                                    } else {
                                        window.location.reload();
                                    }   
                                }
                                request.onerror = function () {
                                    message.innerHTML = "Request failed";
                                }
                                remove_container.appendChild(message);
                                request.send($('#remove_room_form').serialize());
                                e.preventDefault();
                                document.querySelector("#remove_room_form").removeEventListener("submit", formSubmit);
                            }
                        }
                    }
                    var ssn = localStorage.getItem("ssn");
                    xhttp.send(JSON.stringify({"ssn": ssn}));
                }

                //Retriving all the room again for displaying the instruments
                function getRoomsForIns() {
                    //window.location.reload();
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "/get_rooms_admin", true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var rooms = JSON.parse(this.responseText);
                            if (rooms.error) {
                                console.log(rooms.error);
                            return;
                            }
                            let remove_ins = document.querySelector(".remove_ins");
                            let form = document.createElement('form');
                                form.setAttribute("action","/remove_instrument");
                                form.setAttribute("method","POST");
                                form.setAttribute("id","remove_ins_form");
                            remove_ins.appendChild(form);
                            form.addEventListener("submit", formSubmit);
                            let select = document.createElement("select");
                                select.setAttribute("name", "ins_id");
                            form.appendChild(select);
                            for (let i = 0; i < rooms.length; i++) {
                                displayIns(rooms[i].RoomID, select);
                            }
                            let submit = document.createElement("input");
                                submit.setAttribute('type','submit');
                                submit.setAttribute('value','Remove instrument');
                            form.appendChild(submit);

                            //Redirecting to admin page when submitting removal
                            function formSubmit(e) {
                                var url = '/remove_instrument';
                                var request = new XMLHttpRequest();
                                request.open('POST', url, true);
                                let remove_container = document.querySelector(".remove_ins");
                                let message = document.createElement('p');
                                request.onload = function () {
                                    if (JSON.parse(this.responseText).error) {
                                        console.log(JSON.parse(this.responseText).error)
                                    } else {
                                        window.location.reload();
                                    }
                                }
                                request.onerror = function () {
                                    message.innerHTML = "Request failed";
                                }
                                remove_container.appendChild(message);
                                request.send($('#remove_ins_form').serialize());
                                e.preventDefault();
                                document.querySelector("#remove_ins_form").removeEventListener("submit", formSubmit);
                            }
                        }
                    }
                    var ssn = localStorage.getItem("ssn");
                    xhttp.send(JSON.stringify({"ssn": ssn}));
                }

                //Displaying instruments inside the rooms
                function displayIns(RoomID, select) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "/get_instruments_in_room_admin", true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var instrument = JSON.parse(this.responseText);
                            if (instrument.error) {
                                console.log(instrument.error);
                                return;
                            }
                            for (let i = 0; i < instrument.length; i++) {
                                let option = document.createElement("option");
                                    option.setAttribute('class','ins_option');
                                    option.setAttribute('value', `${instrument[i].InsID}`);
                                    option.innerHTML = `Room ${RoomID}: ${instrument[i].description}`;
                                select.appendChild(option);

                            }
                        }
                    }
                    var ssn = localStorage.getItem("ssn");
                    xhttp.send(JSON.stringify({'RoomID': RoomID, 'ssn': ssn}));
                    
                }
                

                //Function for displaying user information
                function getUsers() {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "/get_users", true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var users = JSON.parse(this.responseText);
                            if (users.error) {
                                console.log(users.error);
                            }
                            let table_body = document.querySelector("#user_body");
                            let table_head = document.querySelector("#user_head");
                            //Number of users are the length of users array
                            for (let i = 0; i < users.length; i++) {
                                //Create one table row for each user
                                let tr = document.createElement('tr');
                                table_body.appendChild(tr);
                                //Access all keys for a user
                                for (key in users[i]) {
                                    //Create table heads
                                    if (i === 0) {
                                        let th = document.createElement('th');
                                            th.innerHTML = key;
                                        table_head.appendChild(th);
                                    }
                                    //Fill table rows with table data
                                    let td = document.createElement('td');
                                    if (users[i][key] === 1) {
                                        td.innerHTML = "Yes";
                                    } else if (users[i][key] === 0) {
                                        td.innerHTML = "No";
                                    } else if (key === "SpecRight") {
                                        let button = document.createElement('button');
                                            button.setAttribute('onclick',`changeRights(${users[i]["SSN"]})`);
                                            button.setAttribute('class','change_rights');
                                        td.innerHTML = users[i][key];
                                        td.setAttribute('id',`spec_data_${users[i]["SSN"]}`);
                                        button.innerHTML = "edit";
                                        tr.appendChild(td);
                                        td.appendChild(button);
                                    } else {
                                        td.innerHTML = users[i][key];
                                    }
                                    tr.appendChild(td);
                                }
                                let td = document.createElement('td');
                                let button = document.createElement('button');
                                    button.setAttribute('onclick',`removeUser(${users[i]["SSN"]})`);
                                    button.setAttribute('class','remove_user');
                                    button.innerHTML = "remove";
                                tr.appendChild(td);
                                td.appendChild(button);
                            }
                            let th = document.createElement('th');
                                th.innerHTML = "Remove user";
                            table_head.appendChild(th);
                        }
                    }
                    xhttp.send();
                }

                //Remove user function
                function removeUser(ssn) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST","/remove_user",true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var response = JSON.parse(this.responseText);
                            if(response.error) {
                                console.log(response.error);
                            } else {
                                window.location.href = "ADMIN_DEMO_2.html";
                            }
                        }
                    }
                    xhttp.send(JSON.stringify({"ssn": ssn}));
                }

                //Change special rights function
                function changeRights(ssn) {
                    //Create form for filling in the new special right, action: /set_user_rights 
                    //Sending new special right and ssn
                    let td = document.querySelector(`#spec_data_${ssn}`);
                    $(td).empty();
                    let form = document.createElement('form');
                        form.setAttribute('class','change_right_form');
                        form.setAttribute('action','/set_user_rights');
                        form.setAttribute('method','POST');
                    td.appendChild(form);
                    form.addEventListener("submit", formSubmit);
                    let rights = document.createElement('input');
                        rights.setAttribute('name','Special_rights');
                        rights.setAttribute('type','text');
                    form.appendChild(rights);
                    let ssn_input = document.createElement('input');
                        ssn_input.setAttribute('type','hidden');
                        ssn_input.setAttribute('value',`${ssn}`);
                        ssn_input.setAttribute('name','ssn');
                    form.appendChild(ssn_input);
                    let submit = document.createElement('input');
                        submit.setAttribute('type','submit');
                        submit.setAttribute('value','OK');
                    form.appendChild(submit);
                    //Redirect after submitting new special right
                    function formSubmit(e) {
                        var xhttp = new XMLHttpRequest();
                        xhttp.open("POST","/set_user_rights",true);
                        xhttp.onload = function () {
                            if(JSON.parse(this.responseText).error) {
                                console.log(JSON.parse(this.responseText).error);
                            } else {
                                window.location.reload();
                            }
                        }
                        xhttp.onerror = function() {
                            window.alert("Request failed");
                        }
                        xhttp.send($('.change_right_form').serialize());
                        e.preventDefault();
                        document.querySelector(".change_right_form").removeEventListener("submit", formSubmit);
                    }
                    
                }

                getRooms();
                getRoomsForIns();
                getUsers();


            </script>
        </main>


    </body>


</html>