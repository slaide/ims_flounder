<!DOCTYPE html>
<html> 
    <head>
        <title>Administrator page</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="./reset.css">
        <link rel="stylesheet" type="text/css" href="./flounder.css">
        <link rel="stylesheet" type="text/css" href="./admin.css">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    </head>


    <body>

        <nav class="menu">
            <img src="./favicon.ico" width="256" height="256">
            <ul id="menu_list">
               <a href="./overview.html"><li>Book an instrument</li></a>
               <a href="./my_schedule.html"><li>My Bookings</li></a>
               <a href="#"><li>Administrator</li></a>
            </ul>
            <a id="log_out" href="#" onclick="logOut()">Log out</a>
        </nav>

        <main>
        
            <div id="button_container">
                <h1>Add objects to database</h1>
                <button class="add_button" onclick="document.location='ADD_NEW_USER_ADMIN.html'">Add a new <strong>user</strong></button>
                <button class="add_button" onclick="document.location='ADD_NEW_INSTRUMENT_ADMIN.html'">Add a new <strong>instrument</strong></button>
                <button class="add_button" onclick="document.location='ADD_NEW_ROOM_ADMIN.html'">Add a new <strong>room</strong></button> 
            </div>

            <div id="remove_container">
                <div class="remove_room"></div>
                <div class="remove_ins"></div>
            </div>

            <script>
                //Add maintenance navigering if maintenance personell
                if (localStorage.getItem("main")==="1") {
                let menu_list = document.querySelector('#menu_list');
                let link = document.createElement('a');
                    link.setAttribute('href','maintenance.html');
                    menu_list.appendChild(link);
                let li = document.createElement('li');
                    li.innerHTML = "Maintenance";
                    link.appendChild(li);
                }

                //Log out function
                function logOut() {
                    localStorage.removeItem("ssn");
                    localStorage.removeItem("email");
                    localStorage.removeItem("admin");
                    localStorage.removeItem("main");
                        if (!localStorage.getItem("ssn")) {
                            window.location.replace("index.html");
                    }
                }

                //Function for displaying rooms
                function getRooms() {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "/get_rooms", true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var rooms = JSON.parse(this.responseText);
                            if (rooms.error) {
                                console.log(rooms.error);
                            return;
                            }
                            //Create form for removing room, action: /remove_room
                            let cont = document.querySelector('.remove_room');
                            let form = document.createElement('form');
                                form.setAttribute("action","/remove_room");
                                form.setAttribute("method","POST");
                            cont.appendChild(form);
                            let select_room = document.createElement('select');
                                select_room.setAttribute("name","RoomID");
                            form.appendChild(select_room);
                            for (let i = 0; i < rooms.length; i++) {
                                let option = document.createElement('option');
                                    option.setAttribute("value",`${rooms[i].RoomID}`);
                                    option.innerHTML = `Room ${rooms[i].RoomID}`;
                                select_room.appendChild(option);
                            }
                            let submit = document.createElement('input');
                                submit.setAttribute('type','submit');
                                submit.setAttribute('value','Remove room');
                            form.appendChild(submit);
                        }
                    }
                    var ssn = localStorage.getItem("ssn");
                    xhttp.send(JSON.stringify({"ssn": ssn}));
                }

                //Retriving all the room again for displaying the instruments
                function getRoomsForIns() {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "/get_rooms", true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var rooms = JSON.parse(this.responseText);
                            if (rooms.error) {
                                console.log(rooms.error);
                            return;
                            }
                            let remove_ins = document.querySelector(".remove_ins");
                            let form = document.createElement('form');
                                form.setAttribute("action","/remove_instrument");
                                form.setAttribute("method","POST");
                            remove_ins.appendChild(form);
                            let select = document.createElement("select");
                                select.setAttribute("name", "ins_id");
                            form.appendChild(select);
                            for (let i = 0; i < rooms.length; i++) {
                                displayIns(rooms[i].RoomID, select);
                            }
                            let submit = document.createElement("input");
                                submit.setAttribute('type','submit');
                                submit.setAttribute('value','Remove instrument');
                            form.appendChild(submit);
                        }
                    }
                    var ssn = localStorage.getItem("ssn");
                    xhttp.send(JSON.stringify({"ssn": ssn}));
                }

                //Displaying instruments inside the rooms
                function displayIns(RoomID, select) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "/get_instruments_in_room", true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var instrument = JSON.parse(this.responseText);
                            if (instrument.error) {
                                console.log(instrument.error);
                                return;
                            }
                            for (let i = 0; i < instrument.length; i++) {
                                let option = document.createElement("option");
                                    option.setAttribute('class','ins_option');
                                    option.setAttribute('value', `${instrument[i].InsID}`);
                                    option.innerHTML = `Room ${RoomID}: ${instrument[i].description}`;
                                select.appendChild(option);

                            }
                        }
                    }
                    var ssn = localStorage.getItem("ssn");
                    xhttp.send(JSON.stringify({'RoomID': RoomID, 'ssn': ssn}));
                    
                }

                function getUsers() {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open("POST", "/get_users", true);
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            var users = JSON.parse(this.responseText);
                            if (users.error) {
                                console.log(users.error);
                            }
                        }
                    }
                }

                getRooms();
                getRoomsForIns();


            </script>
        </main>


    </body>


</html>