<!DOCTYPE html>
<html lang="eng">
   <head>
      <title>Flounder - Log In</title>
      <meta charset="UTF-8">
      <link rel="stylesheet" type="text/css" href="./reset.css">
      <link rel="stylesheet" type="text/css" href="./flounder.css">
      <link rel="preconnect" href="https://fonts.gstatic.com">
      <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
   </head>

   <body>
      <!--Unneccesary to have two elements for container-->
      <div class="container">
         <main id="login_container">
            <p> <!--Thought the logo could be nice here-->
               <img src="./Flounder_logo-removebg-preview.png" width="321" height="254">
            </p>
            <!--<h1 id="title">LOG IN</h1>-->
            <!--The class for padding is unneccesary and also all the div tags-->
            <form action="/login" method="POST">
                  <input id="email_form" type="email" name="email" placeholder="Email" required><br>
                  <input id="password_form" type="password" name="password" placeholder="Password" required>
               <p>
                  <input class="button" type="button" value="Log in" onclick="send_hashed_password()">
               </p> 
            </form>
      </main>
   </div>

   <script>
      var wronglogindata=false;
      try{
         wronglogindata=$$LOGINSUCCESS$$
      }catch(e){}

      if (wronglogindata) {
         window.alert('Wrong login data');
      }

      if (localStorage.getItem("ssn")) {
         window.location.replace("overview.html");
      }

      function sha512(data){
         return crypto.subtle.digest("SHA-512",
            new TextEncoder("utf-8").encode(data)
         )
      }

      function send_hashed_password(){
         sha512(document.getElementById("password_form").value).then(
            hashed_password=>{
               const x=Array.prototype.map.call(new Uint8Array(hashed_password), c=>c.toString(16)).join('');

               var xhttp=new XMLHttpRequest()
               xhttp.open("POST","/login",true)
               xhttp.onload=function(){
                  var response=JSON.parse(this.responseText)
                  if(response.error){
                     window.alert(response.error.message)
                     return
                  }
                  if(response.ssn && response.email && typeof(response.admin)!=undefined && typeof(response.maintenance)!=undefined){
                     localStorage.setItem("ssn",response.ssn)
                     localStorage.setItem("main",response.maintenance)
                     localStorage.setItem("admin",response.admin)
                     localStorage.setItem("email",response.email)
                     window.location.href="/overview.html"
                  }else{
                     const r=window.confirm("login failed. incomplete server response. press ok to reload page and try again.")
                     if(r){
                        window.location.reload()
                     }
                  }
               }
               xhttp.onerror=function(){
                  const r=window.confirm("login failed. press ok to reload page and try again.")
                  if(r){
                     window.location.reload()
                  }
               }
               xhttp.send(`?password=${x}&email=${document.getElementById("email_form").value}`)
            }
         )
      }

   </script>

   </body>
</html>