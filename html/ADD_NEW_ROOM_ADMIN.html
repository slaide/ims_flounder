<!DOCTYPE html>
<html lang="eng">
    <!--Title of page and relevant CSS code-->
    <head>
      <title>Add new room</title>
      <meta charset="UTF-8">
      <link rel="stylesheet" type="text/css" href="./reset.css">
      <link rel="stylesheet" type="text/css" href="./flounder.css">
      <link rel="stylesheet" type="text/css" href="./admin.css">
      <link rel="preconnect" href="https://fonts.gstatic.com">
      <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>


    <body>

        <!--Navigate to the other pages -->
        <nav class="menu">
            <img src="./favicon.ico" width="256" height="256">
            <ul id="menu_list">
               <a href="./overview.html"><li>Book an instrument</li></a>
               <a href="./my_schedule.html"><li>My Bookings</li></a>
               <a href="./ADMIN_DEMO_2.html"><li>Administrator</li></a>         
            </ul>
            <!--Log out button-->
            <a id="log_out" href="#" onclick="logOut()">Log out</a>
            <div id="email"></div>
        </nav>

        <!--Form to add new room to the database-->
        <div id="add_room_div">
            <form action="/add_room" method="POST" id="add_room_form"> 

                <br><h2>Please provide the following information:</h2>

                <br><br><label for="area">Area:</label>
                <input type="text" name="area">

                <br><br><label for="capacity">Capacity:</label>
                <input type="text" name="capacity">

                <br><br><label for="building_code">Building code:</label>
                <input type="text" name="building_code">


                <br><br><label for="class">Room class:</label>
                <select name="class" id="class">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>

                <br><input class="button" type="submit" value="Confirm">
            </form>
        </div>


      <!--Scripts-->
      <script>
        if (localStorage.getItem("main")==="1") {
                let menu_list = document.querySelector('#menu_list');
                let link = document.createElement('a');
        link.setAttribute('href','maintenance.html');
        menu_list.appendChild(link);
        let li = document.createElement('li');
            li.innerHTML = "Maintenance";
            link.appendChild(li);
        }
           var form = document.querySelector("#add_room_form");

           getSSN_getToken(form);

           function getSSN_getToken(form){
              var input_SSN = document.createElement("input");
              input_SSN.setAttribute("type","hidden");
              input_SSN.setAttribute("name","ssn");
              input_SSN.setAttribute("value",`${localStorage.getItem("ssn")} `);

              form.appendChild(input_SSN);

              var input_token = document.createElement("input");
              input_token.setAttribute("type","hidden");
              input_token.setAttribute("name","token");
              input_token.setAttribute("value",`${localStorage.getItem("token")} `);

              form.appendChild(input_token);

           }

           //To display the e-mail of current user 
           var email = localStorage.getItem("email");
           document.getElementById("email").innerHTML = email;

           //Listner for submit function and returns error text in the log if error occurs
           document.querySelector("#add_room_form").addEventListener("submit", formSubmit);

           function formSubmit(e) {
                       var xhttp = new XMLHttpRequest();
                       xhttp.open("POST","/add_room",true);
                       xhttp.onload = function () {
                        if(JSON.parse(this.responseText).error) {
                             if(JSON.parse(this.responseText).error.token_expired){
                               logOut();
                             } else {
                              console.log(JSON.parse(this.responseText).error);
                              window.alert("ERROR: " + JSON.parse(this.responseText).error.message);
                              window.location.reload(); 
                               }
                           } else {
                           window.location.href = "ADMIN_DEMO_2.html";
                           }
                    }
                       xhttp.onerror = function() {
                           window.alert("Request failed");
                       }
                       xhttp.send($("#add_room_form").serialize());
                       e.preventDefault();
                       document.querySelector("#add_room_form").removeEventListener("submit", formSubmit);
                   } 

        //Log out function
        function logOut() {
            localStorage.removeItem("ssn");
            localStorage.removeItem("email");
            localStorage.removeItem("admin");
            localStorage.removeItem("main");
            localStorage.removeItem("token");
            window.location.replace("index.html");
        }
    </script>
    </body>
 </html>